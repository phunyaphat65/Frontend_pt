<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå | Part-time Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin:0; padding:0; background:#eef1f9;
      font-family:"Prompt", sans-serif;
      display:flex;
      height:100vh;
      overflow:hidden;
    }

    .sidebar {
      width:240px; background:#ffffff;
      border-right:1px solid #dfe3ef;
      padding:20px 0;
      display:flex; flex-direction:column;
    }

    .logo {
      font-size:20px; font-weight:600; text-align:center;
      color:#444; margin-bottom:24px;
    }

    .menu {
      display:flex; flex-direction:column;
      gap:6px; padding:0 16px;
    }

    .menu a {
      padding:10px 14px;
      text-decoration:none;
      color:#555;
      font-size:15px;
      border-radius:8px;
      transition:0.2s;
    }

    .menu a.active {
      background:#eef2ff;
      color:#4c55d9;
      font-weight:600;
    }

    .menu a:hover { background:#f4f5ff; }

    .logout-area {
      margin-top:auto;
      padding:20px;
    }

    .btn-logout {
      width:100%; border:none; padding:10px;
      background:#d9534f; color:#fff; border-radius:8px;
      cursor:pointer; font-size:14px;
    }

    .main {
      flex:1; overflow-y:auto;
      padding:30px 40px;
    }

    .page-title {
      font-size:26px; color:#222; margin:0;
      font-weight:600;
    }
    .subtitle {
      color:#666; margin-top:4px; font-size:14px;
    }

    .profile-card {
      margin-top:24px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 14px rgba(0,0,0,0.08);
      padding:24px;
      max-width:700px;
    }

    .profile-header {
      display:flex; align-items:center; gap:20px;
    }

    .avatar {
      width:110px; height:110px;
      border-radius:16px; object-fit:cover;
      background:#e4e7ff;
    }

    .btn-change-img {
      background:#ffffff;
      border:1px solid #cfd3ef;
      padding:7px 14px; cursor:pointer;
      border-radius:8px;
      font-size:14px;
      color:#4c55d9;
    }

    .form-group {
      margin-top:18px;
      display:flex; flex-direction:column;
      font-size:14px;
    }

    .form-group label { margin-bottom:6px; color:#444; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding:10px;
      border-radius:8px;
      border:1px solid #cfd3ef;
      font-size:14px;
      background:#f9faff;
    }

    #map {
      width:100%; height:260px;
      border-radius:12px;
      margin-top:10px;
    }

    .btn-save {
      margin-top:22px;
      width:100%;
      background:linear-gradient(90deg,#667eea,#764ba2);
      border:none; color:#fff;
      padding:12px; border-radius:28px;
      cursor:pointer; font-size:15px;
      font-weight:600;
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">Part-time Match</div>

    <div class="menu">
      <a href="profile.html" class="active">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
      <a href="jobs.html">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô</a>
      <a href="applications.html">‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</a>
      <a href="matching.html">AI Matching</a>
      <a href="reviews.html">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</a>
    </div>

    <div class="logout-area">
      <button id="logoutBtn" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <h2 class="page-title">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
    <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

    <div class="profile-card">

      <!-- Profile Picture -->
      <div class="profile-header">
        <img id="avatarPreview" class="avatar" src="./img/default-profile.png" alt="avatar">
        <div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none;">
          <button class="btn-change-img" onclick="document.getElementById('avatarInput').click();">
            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
          </button>
        </div>
      </div>

      <!-- FORM -->
      <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠ ‚Äì ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="fullname" type="text"></div>
      <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input id="email" type="email" readonly></div>
      <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="phone" type="text"></div>

      <div class="form-group"><label>‡πÄ‡∏û‡∏®</label>
        <select id="gender">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
          <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
          <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>

      <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input id="birthday" type="date"></div>
      <div class="form-group"><label>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input id="address" type="text"></div>

      <div class="form-group">
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</label>
        <div id="map"></div>
      </div>

      <div class="form-group"><label>‡∏ó‡∏±‡∏Å‡∏©‡∏∞ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , )</label><textarea id="skills" rows="3"></textarea></div>
      <div class="form-group"><label>‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</label><textarea id="experience" rows="3"></textarea></div>

      <div class="form-group"><label>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏°.)</label><input id="expected_wage" type="number" min="0"></div>
      <div class="form-group"><label>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (YYYY-MM-DD)</label><input id="available_date" type="date"></div>

      <button class="btn-save" id="saveProfileBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ---------------------------
   Config keys
---------------------------- */
const SESSION = "pt_seeker_session";   // session key (‡πÄ‡∏Å‡πá‡∏ö email ‡∏´‡∏£‡∏∑‡∏≠ id)
const PROFILE_KEY = "pt_profile_data"; // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô object ‡∏´‡∏£‡∏∑‡∏≠ map
const USERS_KEY = "pt_users";          // ‡∏ê‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°

/* ---------------------------
   Helpers
---------------------------- */
const $ = id => document.getElementById(id);
const loadJSON = (k, def) => {
  try { return JSON.parse(localStorage.getItem(k) || def); }
  catch(e){ return def; }
};

/* ---------------------------
   ‡∏ï‡∏£‡∏ß‡∏à login
---------------------------- */
const sessionVal = localStorage.getItem(SESSION);
if (!sessionVal) {
  Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô","","warning").then(()=> location.href = "../login.html");
}

/* ---------------------------
   ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á user object ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
   - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å pt_users
---------------------------- */
function normalizeUser(u){
  if (!u) return null;
  // id
  const id = u.id || u.user_id || u._id || null;
  // email
  const email = u.email || u.mail || "";
  // name
  const name = u.name || u.fullname || u.displayName || "";
  // phone
  const phone = u.phone || u.tel || u.mobile || "";
  // avatar
  const avatar = u.avatar || u.profile_image || u.profileImg || u.profile || "";
  // skills: could be string or array
  let skills = [];
  if (Array.isArray(u.skills)) skills = u.skills;
  else if (typeof u.skills === "string" && u.skills.trim() !== "") {
    // try comma separated or space-separated
    skills = u.skills.split(",").map(s=>s.trim()).filter(Boolean);
  }
  // pin: if lat/lng fields exist
  let pin = null;
  const lat = u.lat || u.latitude || u.location_lat || (u.pin && u.pin.lat);
  const lng = u.lng || u.longitude || u.location_lng || (u.pin && u.pin.lng);
  if (typeof lat === "number" && typeof lng === "number") {
    pin = { lat, lng };
  }
  // expected wage & available_date (may be in profile)
  const expected_wage = u.expected_wage || u.want_wage || u.wage || null;
  const available_date = u.available_date || u.available || u.start_date || "";

  return {
    id, email, name, phone, avatar, skills, pin,
    expected_wage, available_date,
    raw: u
  };
}

/* ---------------------------
   ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• profile ‡∏à‡∏≤‡∏Å storage
   - PROFILE_KEY ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô {} ‡∏´‡∏£‡∏∑‡∏≠ { email: profile }
---------------------------- */
function loadProfileForEmail(email){
  const raw = loadJSON(PROFILE_KEY, "{}");

  // ‡∏´‡∏≤‡∏Å PROFILE_KEY ‡πÄ‡∏õ‡πá‡∏ô object mapping { email: profileObj }
  if (raw && typeof raw === "object" && raw[email]) {
    return raw[email];
  }

  // ‡∏´‡∏≤‡∏Å PROFILE_KEY ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏î‡∏¥‡∏°)
  if (raw && typeof raw === "object" && (raw.email === email || !raw.email)) {
    return raw;
  }

  // ‡πÑ‡∏°‡πà‡∏°‡∏µ
  return {};
}

/* ---------------------------
   ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å profile ‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ó‡∏µ‡πà:
   - PROFILE_KEY: ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (object ‡∏´‡∏£‡∏∑‡∏≠ map)
   - pt_users: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï user entry (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ)
---------------------------- */
function saveProfileAndUsers(email, profileObj){
  // 1) PROFILE_KEY: ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô map ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö map[email]=profileObj
  let rawProfile = null;
  try {
    rawProfile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "null");
  } catch(e){ rawProfile = null; }

  if (rawProfile && typeof rawProfile === "object" && !Array.isArray(rawProfile) && Object.keys(rawProfile).length > 0 && rawProfile[email] === undefined) {
    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô: ‡∏ñ‡πâ‡∏≤ rawProfile ‡∏°‡∏µ keys ‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏ï‡∏±‡∏ß ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà profile ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ö‡∏ö map
    rawProfile[email] = profileObj;
    localStorage.setItem(PROFILE_KEY, JSON.stringify(rawProfile));
  } else {
    // ‡∏ñ‡πâ‡∏≤ rawProfile ‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô profile ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ profileObj ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profileObj));
  }

  // 2) pt_users: load, ‡∏´‡∏≤ user ‡∏ï‡∏≤‡∏° email ‡πÅ‡∏•‡πâ‡∏ß update fields ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  let users = loadJSON(USERS_KEY, "[]");
  if (!Array.isArray(users)) users = [];

  const idx = users.findIndex(u => {
    const ue = (u.email || u.mail || "").toLowerCase();
    return ue === (email || "").toLowerCase();
  });

  const standardized = {
    // keep identifiers minimal: if user exists, merge; else create new minimal user
    email: email,
    name: profileObj.fullname || profileObj.name || profileObj.displayName || "",
    phone: profileObj.phone || profileObj.tel || "",
    profile_image: profileObj.avatar || profileObj.profile_image || "",
    skills: Array.isArray(profileObj.skills) ? profileObj.skills : (typeof profileObj.skills === "string" ? profileObj.skills.split(",").map(s=>s.trim()).filter(Boolean) : []),
    lat: (typeof profileObj.lat === "number") ? profileObj.lat : (profileObj.pin && profileObj.pin.lat ? profileObj.pin.lat : undefined),
    lng: (typeof profileObj.lng === "number") ? profileObj.lng : (profileObj.pin && profileObj.pin.lng ? profileObj.pin.lng : undefined),
    expected_wage: profileObj.expected_wage || profileObj.want_wage || null,
    available_date: profileObj.available_date || profileObj.available || ""
  };

  if (idx >= 0) {
    // merge into existing user object
    users[idx] = {
      ...users[idx],
      // prefer existing identifiers, but overwrite fields from profile
      name: standardized.name || users[idx].name || users[idx].fullname || "",
      phone: standardized.phone || users[idx].phone || users[idx].tel || "",
      profile_image: standardized.profile_image || users[idx].profile_image || users[idx].avatar || "",
      // keep skills as array
      skills: standardized.skills && standardized.skills.length ? standardized.skills : (users[idx].skills && Array.isArray(users[idx].skills) ? users[idx].skills : (typeof users[idx].skills === "string" ? users[idx].skills.split(",").map(s=>s.trim()).filter(Boolean) : [])),
      // pin
      lat: standardized.lat !== undefined ? standardized.lat : (users[idx].lat || users[idx].latitude || users[idx].location_lat),
      lng: standardized.lng !== undefined ? standardized.lng : (users[idx].lng || users[idx].longitude || users[idx].location_lng),
      // helper pin object for matching.js
      pin: (standardized.lat !== undefined && standardized.lng !== undefined) ? { lat: standardized.lat, lng: standardized.lng } : (users[idx].pin || null),
      expected_wage: standardized.expected_wage || users[idx].expected_wage || users[idx].want_wage || null,
      available_date: standardized.available_date || users[idx].available_date || users[idx].available || ""
    };
  } else {
    // create new
    const newUser = {
      id: Date.now().toString(),
      email: email,
      role: "seeker",
      name: standardized.name,
      phone: standardized.phone,
      profile_image: standardized.profile_image,
      skills: standardized.skills,
      lat: standardized.lat,
      lng: standardized.lng,
      pin: (standardized.lat !== undefined && standardized.lng !== undefined) ? { lat: standardized.lat, lng: standardized.lng } : null,
      expected_wage: standardized.expected_wage,
      available_date: standardized.available_date,
      created_at: new Date().toISOString()
    };
    users.push(newUser);
  }

  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

/* ---------------------------
   ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
---------------------------- */
function populateForm(){
  // load pt_profile_data (may be single object or map)
  // determine email to use from session (sessionVal may be email or id)
  let email = null;
  // If session stores email (common), use it
  if (sessionVal && sessionVal.includes && sessionVal.includes("@")) email = sessionVal;
  // else try to lookup user by id in pt_users
  let users = loadJSON(USERS_KEY, "[]");
  if (!Array.isArray(users)) users = [];
  if (!email) {
    // session might be id
    const byId = users.find(u => (u.id && u.id.toString() === sessionVal.toString()) || (u.user_id && u.user_id.toString() === sessionVal.toString()));
    if (byId) email = byId.email || byId.mail || "";
  }

  // If still no email, we can't proceed
  if (!email) {
    // fallback: if profile storage is single object, use its email
    const rawProfile = loadJSON(PROFILE_KEY, "{}");
    if (rawProfile && rawProfile.email) email = rawProfile.email;
  }

  if (!email) {
    // give up gracefully
    console.warn("Cannot determine current user email from session.");
    return;
  }

  // load profile (supports map or single object)
  const profile = loadProfileForEmail(email) || {};

  // If profile empty, try to find in pt_users and normalize
  let norm = {};
  if ((!profile || Object.keys(profile).length === 0) && users.length) {
    const u = users.find(u2 => (u2.email && u2.email.toLowerCase() === email.toLowerCase()) || (u2.user_id && u2.user_id.toString() === sessionVal.toString()) || (u2.id && u2.id.toString() === sessionVal.toString()));
    if (u) norm = normalizeUser(u);
    // map normalized fields into profile-compatible shape
    if (norm && Object.keys(norm).length) {
      if (!profile || Object.keys(profile).length === 0) {
        // create a profile-like object from norm
        profile.fullname = profile.fullname || norm.name || "";
        profile.email = profile.email || norm.email || email;
        profile.phone = profile.phone || norm.phone || "";
        profile.avatar = profile.avatar || norm.avatar || "";
        profile.skills = (norm.skills && norm.skills.length) ? norm.skills.join(", ") : (profile.skills || "");
        if (norm.pin) { profile.lat = norm.pin.lat; profile.lng = norm.pin.lng; }
        profile.expected_wage = profile.expected_wage || norm.expected_wage || "";
        profile.available_date = profile.available_date || norm.available_date || "";
        profile.experience = profile.experience || (norm.raw && norm.raw.experience) || profile.experience || "";
        profile.address = profile.address || (norm.raw && norm.raw.address) || profile.address || "";
      }
    }
  }

  // Fill form fields with profile (if empty fallback to values from user record)
  const fields = ["fullname","email","phone","gender","birthday","address","skills","experience","expected_wage","available_date"];
  fields.forEach(id => {
    const el = $(id);
    if (!el) return;
    if (profile[id] !== undefined && profile[id] !== null) {
      el.value = profile[id];
    } else {
      // fallback: try from user record
      const u = users.find(u2 => (u2.email && u2.email.toLowerCase() === email.toLowerCase()) || (u2.user_id && u2.user_id.toString() === sessionVal.toString()) || (u2.id && u2.id.toString() === sessionVal.toString()));
      if (u) {
        // map possible fields
        if (id === "fullname") el.value = u.fullname || u.name || u.displayName || u.name || "";
        else if (id === "phone") el.value = u.phone || u.tel || u.mobile || "";
        else if (id === "skills") {
          if (Array.isArray(u.skills)) el.value = u.skills.join(", ");
          else if (typeof u.skills === "string") el.value = u.skills;
        } else if (id === "address") el.value = u.address || u.location || "";
        else if (id === "experience") el.value = u.experience || "";
        else if (id === "email") el.value = u.email || u.mail || "";
        else if (id === "expected_wage") el.value = u.expected_wage || u.want_wage || "";
        else if (id === "available_date") el.value = u.available_date || u.available || "";
        else el.value = "";
      }
    }
  });

  // avatar
  const avatarEl = $("avatarPreview");
  if (profile.avatar) avatarEl.src = profile.avatar;
  else {
    // try pt_users profile_image
    const u = users.find(u2 => (u2.email && u2.email.toLowerCase() === email.toLowerCase()) || (u2.user_id && u2.user_id.toString() === sessionVal.toString()) || (u2.id && u2.id.toString() === sessionVal.toString()));
    if (u) {
      const pic = u.profile_image || u.profileImg || u.avatar || u.profile_image_url || "";
      if (pic) avatarEl.src = pic;
    }
  }

  // map: if profile has lat/lng use them; else try user record
  let lat = undefined, lng = undefined;
  if (profile.lat && profile.lng) {
    lat = profile.lat; lng = profile.lng;
  } else {
    const u = users.find(u2 => (u2.email && u2.email.toLowerCase() === email.toLowerCase()) || (u2.user_id && u2.user_id.toString() === sessionVal.toString()) || (u2.id && u2.id.toString() === sessionVal.toString()));
    if (u) {
      lat = u.lat || (u.pin && u.pin.lat) || u.latitude;
      lng = u.lng || (u.pin && u.pin.lng) || u.longitude;
    }
  }

  // store into window for initMap and for save
  window.__SEEKER_CURRENT = {
    email,
    lat: (typeof lat === "number") ? lat : (lat ? Number(lat) : undefined),
    lng: (typeof lng === "number") ? lng : (lng ? Number(lng) : undefined)
  };
}

/* ---------------------------
   Avatar upload -> base64 + update profile & pt_users
---------------------------- */
$("avatarInput").addEventListener("change", function(){
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const base64 = e.target.result;
    $("avatarPreview").src = base64;

    // update profile in storage and users
    const email = window.__SEEKER_CURRENT && window.__SEEKER_CURRENT.email;
    if (!email) return;
    // update profile object (merge)
    let p = loadProfileForEmail(email) || {};
    p.avatar = base64;
    // write back
    saveProfileAndUsers(email, p);
  };
  reader.readAsDataURL(file);
});

/* ---------------------------
   Map init
---------------------------- */
let map, marker;
function initMap(){
  populateForm(); // ensure __SEEKER_CURRENT set

  const cur = window.__SEEKER_CURRENT || {};
  const defLat = (cur.lat !== undefined && cur.lat !== null) ? cur.lat : 13.7563;
  const defLng = (cur.lng !== undefined && cur.lng !== null) ? cur.lng : 100.5018;

  const pos = { lat: Number(defLat), lng: Number(defLng) };

  map = new google.maps.Map(document.getElementById("map"), {
    center: pos,
    zoom: 13
  });

  marker = new google.maps.Marker({
    position: pos,
    map,
    draggable: true
  });

  marker.addListener("dragend", () => {
    const p = marker.getPosition();
    const lat = p.lat(); const lng = p.lng();
    // save to profile and users
    const email = window.__SEEKER_CURRENT && window.__SEEKER_CURRENT.email;
    if (!email) return;
    let profileObj = loadProfileForEmail(email) || {};
    profileObj.lat = lat; profileObj.lng = lng;
    saveProfileAndUsers(email, profileObj);
  });

  map.addListener("click", e => {
    marker.setPosition(e.latLng);
    const lat = e.latLng.lat(); const lng = e.latLng.lng();
    const email = window.__SEEKER_CURRENT && window.__SEEKER_CURRENT.email;
    if (!email) return;
    let profileObj = loadProfileForEmail(email) || {};
    profileObj.lat = lat; profileObj.lng = lng;
    saveProfileAndUsers(email, profileObj);
  });
}

/* ---------------------------
   Save Profile button
---------------------------- */
$("saveProfileBtn").addEventListener("click", () => {
  const email = window.__SEEKER_CURRENT && window.__SEEKER_CURRENT.email;
  if (!email) {
    Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ","‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ","error");
    return;
  }

  const pos = marker ? marker.getPosition() : null;
  const lat = pos ? pos.lat() : (window.__SEEKER_CURRENT && window.__SEEKER_CURRENT.lat);
  const lng = pos ? pos.lng() : (window.__SEEKER_CURRENT && window.__SEEKER_CURRENT.lng);

  // collect fields
  const profileObj = {
    fullname: $("fullname").value || "",
    email: $("email").value || email,
    phone: $("phone").value || "",
    gender: $("gender").value || "",
    birthday: $("birthday").value || "",
    address: $("address").value || "",
    skills: $("skills").value || "",
    experience: $("experience").value || "",
    avatar: $("avatarPreview").src || "",
    lat: (typeof lat === "number") ? lat : (lat ? Number(lat) : undefined),
    lng: (typeof lng === "number") ? lng : (lng ? Number(lng) : undefined),
    expected_wage: ($("expected_wage").value ? Number($("expected_wage").value) : null),
    available_date: $("available_date").value || ""
  };

  // Save to PROFILE and update pt_users
  saveProfileAndUsers(email, profileObj);

  Swal.fire({
    icon: "success",
    title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß",
    timer: 1200,
    showConfirmButton: false
  });
});

/* ---------------------------
   Logout (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå session ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
---------------------------- */
$("logoutBtn").addEventListener("click", () => {
  Swal.fire({
    icon:"warning",
    title:"‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?",
    showCancelButton:true,
    confirmButtonText:"‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    confirmButtonColor:"#d9534f"
  }).then(res => {
    if (res.isConfirmed) {
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ session ‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      localStorage.setItem(SESSION, "");
      // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login (root)
      location.href = "../login.html";
    }
  });
});

/* ---------------------------
   ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å populate ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤
---------------------------- */
populateForm();

</script>

<!-- Google Maps -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhOq2e2YYl308urG4HnTDRr4pqKdv8jhE&callback=initMap">
</script>

</body>
</html>
