<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>üíº ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô | Part-time Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../common/css/style.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: "Prompt", sans-serif; background: #f8faff; margin: 0; }

    /* Navbar */
    .navbar {
      background: linear-gradient(90deg,#667eea,#764ba2);
      padding: 14px 24px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-right a {
      color:#fff;
      margin-right:14px;
      text-decoration:none;
      font-weight:500;
    }

    .nav-right a.active {
      text-decoration:underline;
      font-weight:600;
      opacity:0.85;
    }

    /* Logout button */
    .btn-logout {
      background: rgba(255,255,255,0.25);
      border: none;
      padding: 8px 14px;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.25s;
    }
    .btn-logout:hover {
      background: rgba(255,255,255,0.35);
    }

    /* Container */
    .container {
      max-width:900px;
      margin:40px auto;
      background:#fff;
      padding:35px 45px;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      animation: fadeIn .4s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(8px); }
      to { opacity:1; transform:translateY(0); }
    }

    .job-list {
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    }

    .job-card {
      background:#fafbff;
      padding:16px;
      border-radius:12px;
      box-shadow:0 3px 8px rgba(0,0,0,0.1);
      transition:.25s;
    }

    .job-card:hover {
      transform:translateY(-4px);
      box-shadow:0 4px 12px rgba(0,0,0,0.12);
    }

    /* Modal */
    .modal {
      position:fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      background:rgba(0,0,0,0.45);
      z-index:999;
    }

    .hidden { display:none; }

    .modal-content {
      background:#fff;
      padding:25px 30px;
      width:95%;
      max-width:600px;
      border-radius:16px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 8px 24px rgba(0,0,0,0.2);
      position:relative;
      animation: fadeIn .35s ease-in-out;
    }

    .modal-content input, .modal-content textarea {
      width:100%;
      padding:9px;
      margin-bottom:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:15px;
    }

    #map { height:220px; border-radius:10px; margin-bottom:10px; }

    .preview-img {
      width:100%;
      max-height:200px;
      border-radius:8px;
      display:none;
      object-fit:cover;
      margin-bottom:10px;
    }

    .btn-save {
      width:100%;
      padding:10px;
      border:none;
      background:linear-gradient(90deg,#667eea,#764ba2);
      color:#fff;
      border-radius:8px;
      cursor:pointer;
      font-size:16px;
    }

    .modal-close {
      position:absolute;
      top:10px;
      right:12px;
      font-size:22px;
      cursor:pointer;
      color:#888;
    }
  </style>
</head>

<body>

<!-- Navbar -->
<nav class="navbar">
  <h2 style="margin:0;">Part-time Match (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)</h2>

  <div class="nav-right">
    <a href="matching.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    <a href="profile.html">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
    <a href="jobs.html" class="active">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
    <a href="applications.html">‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</a>
    <a href="matching.html">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</a>
    <a href="reviews.html">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô</a>

    <button id="logoutBtn" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</nav>

<div class="container">
  <h2>üíº ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2>

  <button id="addJobBtn" style="
    background:linear-gradient(90deg,#667eea,#764ba2);
    color:#fff;
    padding:10px 18px;
    border:none;
    border-radius:10px;
    cursor:pointer;">
    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
  </button>

  <div id="jobList" class="job-list"></div>
  <p id="emptyState" style="text-align:center;color:#888;margin-top:20px;display:none;">
    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
  </p>
</div>

<!-- Modal -->
<div id="jobModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeModal" class="modal-close">&times;</span>
    <h3 id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>

    <input type="text" id="jobTitle" placeholder="üßæ ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô" required>
    <textarea id="jobDesc" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>

    <input type="text" id="jobLocation" placeholder="üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î" required>
    <div id="map"></div>

    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</label>
    <input type="date" id="jobStart">

    <input type="number" id="jobWage" placeholder="üí∞ ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏°.)" required>
    <input type="tel" id="jobContact" placeholder="üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">

    <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô:</label>
    <input type="file" id="jobImage" accept="image/*">
    <img id="previewImage" class="preview-img">

    <button id="saveJobBtn" class="btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
  </div>
</div>

<script>
// ---------------------------
// üîê Session ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
// ---------------------------
const SESSION_SHOP = "pt_shop_session";
const USERS_KEY = "pt_users";
const JOB_STORAGE = "pt_jobs";

const shopEmail = localStorage.getItem(SESSION_SHOP);
if (!shopEmail) {
  alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
  window.location.href = "../auth.html";
}

const users = JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
const shopInfo = users.find(u => u.email === shopEmail);

let jobs = JSON.parse(localStorage.getItem(JOB_STORAGE)) || [];

// ---------------------------
// UI Elements
// ---------------------------
const modal = document.getElementById("jobModal");
const openBtn = document.getElementById("addJobBtn");
const closeBtn = document.getElementById("closeModal");
const jobListEl = document.getElementById("jobList");
const emptyState = document.getElementById("emptyState");

let map, marker;
let selectedImageBase64 = "";

// ---------------------------
// ‡πÄ‡∏õ‡∏¥‡∏î Modal
// ---------------------------
openBtn.onclick = () => {
  resetForm();
  modal.classList.remove("hidden");
  setTimeout(initMap, 200);
};

// ‡∏õ‡∏¥‡∏î Modal
closeBtn.onclick = () => modal.classList.add("hidden");

// ---------------------------
// Preview Image
// ---------------------------
document.getElementById("jobImage").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    selectedImageBase64 = evt.target.result;
    const img = document.getElementById("previewImage");
    img.src = selectedImageBase64;
    img.style.display = "block";
  };
  reader.readAsDataURL(file);
});

// ---------------------------
// Leaflet Map
// ---------------------------
function initMap() {
  if (!map) {
    map = L.map("map").setView([13.7563, 100.5018], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    map.on("click", e => {
      if (marker) map.removeLayer(marker);

      marker = L.marker(e.latlng).addTo(map);
      document.getElementById("jobLocation").value =
        `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
    });
  }

  setTimeout(() => map.invalidateSize(), 200);
}

// ---------------------------
// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
// ---------------------------
document.getElementById("saveJobBtn").onclick = () => {
  const title = document.getElementById("jobTitle").value.trim();
  const desc = document.getElementById("jobDesc").value.trim();
  const locText = document.getElementById("jobLocation").value.trim();
  const start = document.getElementById("jobStart").value;
  const wage = document.getElementById("jobWage").value;
  const contact = document.getElementById("jobContact").value;

  if (!title || !locText || !wage) {
    Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "", "warning");
    return;
  }

  let lat = null, lng = null;
  if (marker) {
    lat = marker.getLatLng().lat;
    lng = marker.getLatLng().lng;
  }

  const newJob = {
    id: Date.now(),
    shop_email: shopEmail,
    shop_name: shopInfo?.name || "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
    title,
    desc,
    location_text: locText,
    lat,
    lng,
    startDate: start,
    wage,
    contact,
    image: selectedImageBase64 || "",
    created_at: new Date().toISOString()
  };

  jobs.push(newJob);
  localStorage.setItem(JOB_STORAGE, JSON.stringify(jobs));

  Swal.fire("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");

  modal.classList.add("hidden");
  renderJobs();
};

// ---------------------------
// ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô
// ---------------------------
function renderJobs() {
  const shopJobs = jobs.filter(j => j.shop_email === shopEmail);

  jobListEl.innerHTML = "";
  emptyState.style.display = shopJobs.length === 0 ? "block" : "none";

  shopJobs.forEach(job => {
    const card = document.createElement("div");
    card.className = "job-card";
    card.innerHTML = `
      <h4>${job.title}</h4>
      <p>üè™ ‡∏£‡πâ‡∏≤‡∏ô: ${job.shop_name}</p>
      <p>üìç ${job.location_text}</p>
      <p>üó∫ Lat: ${job.lat || "-"}, Lng: ${job.lng || "-"}</p>
      <p>üí∞ ${job.wage} ‡∏ö‡∏≤‡∏ó/‡∏ä‡∏°.</p>
      <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: ${job.startDate || "-"}</p>
    `;
    jobListEl.appendChild(card);
  });
}

// ---------------------------
// ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
// ---------------------------
function resetForm() {
  document.getElementById("jobTitle").value = "";
  document.getElementById("jobDesc").value = "";
  document.getElementById("jobLocation").value = "";
  document.getElementById("jobStart").value = "";
  document.getElementById("jobWage").value = "";
  document.getElementById("jobContact").value = "";
  selectedImageBase64 = "";
  document.getElementById("previewImage").style.display = "none";
}

// ---------------------------
// Logout
// ---------------------------
document.getElementById("logoutBtn").onclick = () => {
  Swal.fire({
    title: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
  }).then(res => {
    if (res.isConfirmed) {
      localStorage.removeItem(SESSION_SHOP);
      window.location.href = "../auth.html";
    }
  });
};

// ---------------------------
// ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
// ---------------------------
renderJobs();
</script>

</body>
</html>
