// ==========================
// auth.js (à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡)
// ==========================

// à¸à¸³à¸«à¸™à¸” key à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ localStorage
const SESSION_KEY = "pt_session";
const USERS_KEY = "pt_users";

// âœ… à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
function getCurrentUser() {
  try {
    const email = localStorage.getItem(SESSION_KEY);
    if (!email) return null;

    const users = JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
    return users.find(u => u.email === email) || null;
  } catch (err) {
    console.error("Error getting current user:", err);
    return null;
  }
}

// âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡
function requireLogin(redirect = true) {
  const user = getCurrentUser();
  if (!user && redirect) {
    alert("à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸à¹ˆà¸­à¸™");
    window.location.href = "auth.html"; // à¹„à¸›à¸«à¸™à¹‰à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š
  }
  return user;
}

// âœ… à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š
function logout() {
  if (confirm("à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?")) {
    localStorage.removeItem(SESSION_KEY);
    alert("à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ ðŸ‘‹");
    window.location.href = "auth.html";
  }
}

// âœ… à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸¥à¹‡à¸­à¸à¸­à¸´à¸™ (à¹€à¸à¹‡à¸š session)
function login(email) {
  if (!email) return;
  localStorage.setItem(SESSION_KEY, email);
}

// âœ… à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸ (à¹€à¸žà¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ)
function registerUser(newUser) {
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
  if (users.find(u => u.email === newUser.email)) {
    alert("à¸­à¸µà¹€à¸¡à¸¥à¸™à¸µà¹‰à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§");
    return false;
  }
  users.push(newUser);
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  alert("à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ ðŸŽ‰");
  return true;
}

// âœ… à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™
function resetPassword(email, newPassword) {
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
  const index = users.findIndex(u => u.email === email);
  if (index === -1) {
    alert("à¹„à¸¡à¹ˆà¸žà¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸™à¸µà¹‰à¹ƒà¸™à¸£à¸°à¸šà¸š");
    return false;
  }
  users[index].password = newPassword;
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  alert("à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ âœ…");
  return true;
}

// âœ… à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š session à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸™à¸—à¸¸à¸à¸«à¸™à¹‰à¸² (à¸¢à¸à¹€à¸§à¹‰à¸™à¸«à¸™à¹‰à¸² auth)
document.addEventListener("DOMContentLoaded", () => {
  const authPages = ["auth.html", "register.html"];
  const currentPage = window.location.pathname.split("/").pop();
  if (!authPages.includes(currentPage)) {
    requireLogin(true);
  }
});
